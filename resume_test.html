<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Optimizer Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
        }
        #progress-panel {
            width: 30%;
            background-color: #f0f0f0;
            padding: 20px;
            border-right: 1px solid #ccc;
            overflow-y: auto;
        }
        #content-panel {
            width: 70%;
            padding: 20px;
            overflow-y: auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="file"], textarea, input[type="text"] {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            margin-bottom: 5px;
        }
        textarea {
            min-height: 100px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        #analysis-results, #optimization-results {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            background-color: #f9f9f9;
            white-space: pre-wrap; /* Preserve formatting */
            max-height: 400px;
            overflow-y: auto;
        }
        .file-upload-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        #step2-form {
            display: none; /* Hidden initially */
            margin-top: 30px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }
        .progress-item {
            padding: 5px 0;
            border-bottom: 1px dashed #ccc;
        }
        .progress-item.complete {
            color: green;
            font-weight: bold;
        }
        .progress-item.error {
            color: red;
            font-weight: bold;
        }
        h1, h2, h3 {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div id="progress-panel">
        <h2>Progress</h2>
        <div id="progress-log">
            <div class="progress-item">Waiting to start...</div>
        </div>
    </div>

    <div id="content-panel">
        <!-- Step 1: Analyze Resume -->
        <div id="step1">
            <h1>Step 1: Analyze Resume</h1>
            <form id="analyzeForm">
                <div class="form-group">
                    <label for="resume">Upload Resume (PDF/Word):</label>
                    <input type="file" id="resume" name="resume" accept=".pdf,.doc,.docx" required>
                        </div>
                <button type="submit">Analyze Resume</button>
            </form>
            <div id="analysis-results-container" style="display: none;">
                <h3>Analysis Results:</h3>
                <div id="analysis-results"></div>
                    </div>
                    </div>

        <!-- Step 2: Provide Answers and Optimize -->
        <div id="step2-form">
            <h2>Step 2: Provide Answers & Optimize</h2>
            <form id="optimizeForm">
                <input type="hidden" id="resume_analysis_key" name="resume_analysis_key">

                <div class="form-group">
                    <label for="answers">Answers to Questions:</label>
                    <textarea id="answers" name="answers" placeholder="Provide answers to the questions generated in Step 1..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="job_description">Job Description (Optional Text File):</label>
                    <input type="file" id="job_description" name="job_description" accept=".txt">
                    <div class="file-upload-info">Upload a .txt file containing the job description</div>
                </div>
                
                <div class="form-group">
                    <label for="additional_info">Additional Information (Optional):</label>
                    <textarea id="additional_info" name="additional_info" placeholder="Any other relevant information about yourself..."></textarea>
                </div>
                
                <button type="submit">Optimize Resume</button>
            </form>
            <div id="optimization-results-container" style="display: none;">
                <h3>Optimization Results:</h3>
                <div id="optimization-results"></div>
            </div>
        </div>
    </div>

    <script>
        const analyzeForm = document.getElementById('analyzeForm');
        const optimizeForm = document.getElementById('optimizeForm');
        const progressLog = document.getElementById('progress-log');
        const analysisResultsContainer = document.getElementById('analysis-results-container');
        const analysisResultsDiv = document.getElementById('analysis-results');
        const optimizationResultsContainer = document.getElementById('optimization-results-container');
        const optimizationResultsDiv = document.getElementById('optimization-results');
        const step2FormDiv = document.getElementById('step2-form');
        const resumeAnalysisKeyInput = document.getElementById('resume_analysis_key');
        const answersTextarea = document.getElementById('answers'); // Get the answers textarea

        function logProgress(message, type = 'info') {
            const item = document.createElement('div');
            item.classList.add('progress-item');
            item.textContent = message;
            if (type === 'complete') {
                item.classList.add('complete');
            } else if (type === 'error') {
                item.classList.add('error');
            }
            // Prepend to show latest first
            progressLog.insertBefore(item, progressLog.firstChild);
        }

        // --- Step 1: Analyze Resume ---
        analyzeForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            progressLog.innerHTML = ''; // Clear previous logs
            logProgress('Step 1: Starting Resume Analysis...');
            analysisResultsContainer.style.display = 'none';
            step2FormDiv.style.display = 'none'; // Hide step 2 form
            
            const formData = new FormData();
            formData.append('resume', document.getElementById('resume').files[0]);
            
            try {
                const response = await fetch('http://localhost:8000/api/resume/analyze', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Analysis failed: ${response.status} - ${errorText}`);
                }

                const data = await response.json();

                logProgress('Step 1: Analysis Complete!', 'complete');
                analysisResultsDiv.textContent = JSON.stringify(data.analysis, null, 2);
                analysisResultsContainer.style.display = 'block';

                // Store the key and show Step 2
                resumeAnalysisKeyInput.value = data.resume_analysis_key;
                step2FormDiv.style.display = 'block';

                // Pre-fill answers textarea with questions for convenience
                if (data.analysis && data.analysis.follow_up_questions && Array.isArray(data.analysis.follow_up_questions)) {
                    answersTextarea.value = "Answers:\n\n" + data.analysis.follow_up_questions.map((q, i) => `${i + 1}. ${q}\n\n`).join('');
                    answersTextarea.focus(); // Focus on answers
                }


            } catch (error) {
                logProgress(`Step 1 Error: ${error.message}`, 'error');
                analysisResultsDiv.textContent = `Error: ${error.message}`;
                analysisResultsContainer.style.display = 'block';
                console.error('Analysis Error:', error);
            }
        });

        // --- Step 2: Optimize Resume ---
        optimizeForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            logProgress('Step 2: Starting Resume Optimization Flow...');
            optimizationResultsContainer.style.display = 'none';
            optimizationResultsDiv.textContent = ''; // Clear previous optimization results

            const formData = new FormData();
            formData.append('resume_analysis_key', resumeAnalysisKeyInput.value);
            formData.append('answers', document.getElementById('answers').value);
            formData.append('additional_info', document.getElementById('additional_info').value);

            const jobDescFile = document.getElementById('job_description').files[0];
            if (jobDescFile) {
                formData.append('job_description', jobDescFile);
            }
            
            try {
                const response = await fetch('http://localhost:8000/api/resume/optimize', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok || !response.body) {
                     const errorText = await response.text();
                    throw new Error(`Optimization request failed: ${response.status} - ${errorText}`);
                }
                
                optimizationResultsContainer.style.display = 'block'; // Show container for streaming results

                // Handle Server-Sent Events
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) {
                        logProgress('Step 2: Optimization Flow Finished.', 'complete');
                        break;
                    }
                    
                    const text = decoder.decode(value);
                    // Process potentially multiple events in one chunk
                    const events = text.split('\n\n').filter(line => line.trim().startsWith('data: '));
                    
                    for (const event of events) {
                         try {
                            const eventData = JSON.parse(event.substring(6)); // Remove 'data: ' prefix
                            // Log progress updates
                            if (eventData.type === 'status') {
                                logProgress(`Step 2: ${eventData.message}`);
                            } else if (eventData.type === 'task_complete') {
                                logProgress(`Step 2: Task '${eventData.task}' completed.`, 'complete');
                                // Display final result if it's the optimization task
                                if (eventData.task === 'optimized_resume') {
                                    optimizationResultsDiv.textContent = JSON.stringify(eventData.data, null, 2);
                                }
                            } else if (eventData.type === 'complete') {
                                logProgress(`Step 2: ${eventData.message || 'Flow Complete'}`, 'complete');
                            } else if (eventData.type === 'error') {
                                logProgress(`Step 2 Error: ${eventData.message || 'Unknown error'}`, 'error');
                                optimizationResultsDiv.textContent += `\nERROR: ${eventData.message || 'Unknown error'}`;
                            }
                            // Optionally display intermediate data in results
                            // optimizationResultsDiv.textContent += JSON.stringify(eventData, null, 2) + '\n\n';

                        } catch (e) {
                            console.error('Error parsing SSE event data:', e, 'Raw event:', event);
                            logProgress('Step 2: Error processing stream data.', 'error');
                        }
                    }
                }

            } catch (error) {
                logProgress(`Step 2 Error: ${error.message}`, 'error');
                optimizationResultsDiv.textContent = `Error: ${error.message}`;
                optimizationResultsContainer.style.display = 'block';
                console.error('Optimization Error:', error);
            }
        });

    </script>
</body>
</html> 